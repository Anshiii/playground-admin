<!DOCTYPE html>

<html>
<head>
<title>Activity Log - QOR5 Documentation</title>

<meta name='description'>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<base href='/qor5/'>

<link href='index.css' rel='stylesheet' type='text/css'>

<script type='text/javascript' defer src='index.js'></script>
</head>

<body>
<div id='app' v-cloak>
<nav class='bg-gray-700 py-3 text-base font-normal mb-8'>
<div aria-label='Breadcrumbs' class='flex list-none lg:max-w-5xl mx-auto px-6 sm:px-10'>
<div class='flex'>
<a href='index.html' class='text-gray-50'>QOR5 Documentation</a>
</div>

<div class='flex'>
<div class='w-3 m-2 fill-current text-gray-500'>
<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" data-v-134594fd="" data-v-838665fe=""><path data-v-7abeccde="" d="m4.81347656 13.1269531c.22558594 0 .41015625-.0820312.56738282-.2324219l5.31835942-5.19531245c.1845703-.19140625.2802734-.38964844.2802734-.63574219 0-.23925781-.0888672-.45117187-.2802734-.62890625l-5.31835942-5.20214843c-.15722657-.15039063-.34179688-.23242188-.56738282-.23242188-.45800781 0-.81347656.35546875-.81347656.80664062 0 .21875.09570312.43066407.24609375.58789063l4.79199219 4.67578125-4.79199219 4.6621094c-.15722656.1640625-.24609375.3623047-.24609375.5878906 0 .4511719.35546875.8066406.81347656.8066406z"></path></svg>
</div>

<a href='activity-log.html' class='text-gray-50'>Activity Log</a>
</div>
</div>
</nav>

<div>
<main class='lg:max-w-5xl mx-auto px-6 sm:px-8'>
<h1>Activity Log</h1>

<div class='sm:flex mt-8 mb-16'>
<div class='sm:w-9/12'>
<div class='border-t'>Activity provides a more flexible way to record the user&#39;s CRUD operation.
<h2>Definition</h2>

<h5>ActivityBuilder is used to register all model builders and add CRUD operation log.</h5>

<bran-code language='go'>
<template slot='sourcecode'>type ActivityBuilder struct {
	creatorContextKey interface{}          // get the creator from context
	dbContextKey      interface{}          // get the db from context
	logModel          ActivityLogInterface // log model
	models            []*ModelBuilder      // registered model builders
}
</template>
</bran-code>

<h5>ModelBuilder is mainly used to provide recording behavior when a model data is changed.</h5>

<bran-code language='go'>
<template slot='sourcecode'>type ModelBuilder struct {
	typ           reflect.Type
	keys          []string                     // primary keys
	explicitly    bool                         // if ture, will don&#39;t record any log on callback db
	link          func(interface{}) string     // display the model link on the admin detail page
	ignoredFields []string                     // ignored fields
	typeHanders   map[reflect.Type]TypeHandler // type handlers
}
</template>
</bran-code>

<h5>TypeHandler is used to process special types when diffing a modified data.</h5>

<bran-code language='go'>
<template slot='sourcecode'>type TypeHandler func(old, now interface{}, prefixField string) []Diff
</template>
</bran-code>

<h5>ActivityDefaultTypeHandles is the global type handler</h5>

<bran-code language='go'>
<template slot='sourcecode'>DefaultTypeHandles = map[reflect.Type]TypeHandler{
	reflect.TypeOf(time.Time{}): func(old, now interface{}, prefixField string) []Diff {
		oldString := old.(time.Time).Format(time.RFC3339)
		nowString := now.(time.Time).Format(time.RFC3339)
		if oldString != nowString {
			return []Diff{
				{Field: prefixField, Old: oldString, Now: nowString},
			}
		}
		return []Diff{}
	},
	reflect.TypeOf(media_library.MediaBox{}): func(old, now interface{}, prefixField string) (diffs []Diff) {
		oldMediaBox := old.(media_library.MediaBox)
		nowMediaBox := now.(media_library.MediaBox)

		if oldMediaBox.Url != nowMediaBox.Url {
			diffs = append(diffs, Diff{Field: fmt.Sprintf(&#34;%s.Url&#34;, prefixField), Old: oldMediaBox.Url, Now: nowMediaBox.Url})
		}

		if oldMediaBox.Description != nowMediaBox.Description {
			diffs = append(diffs, Diff{Field: fmt.Sprintf(&#34;%s.Description&#34;, prefixField), Old: oldMediaBox.Description, Now: nowMediaBox.Description})
		}

		if oldMediaBox.VideoLink != nowMediaBox.VideoLink {
			diffs = append(diffs, Diff{Field: fmt.Sprintf(&#34;%s.VideoLink&#34;, prefixField), Old: oldMediaBox.VideoLink, Now: nowMediaBox.VideoLink})
		}

		return diffs
	},
}</template>
</bran-code>

<h5>DefaultIgnoredFields is the global default field that needs to be ignored when diffing a modified data.</h5>

<bran-code language='go'>
<template slot='sourcecode'>DefaultIgnoredFields = []string{&#34;ID&#34;, &#34;UpdatedAt&#34;, &#34;DeletedAt&#34;, &#34;CreatedAt&#34;}</template>
</bran-code>
<h2><a name="usage" class="anchor" href="#usage" rel="nofollow" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<ul>
<li><p>Initalize the activity with the <code>Activity</code> method.</p>

<div class="highlight highlight-go"><pre>activity := Activity().
	SetLogModel(&amp;model.ActivityLog{}). // store activity log in model.ActivityLog
	SetDBContextKey(&#34;DB&#34;). // set db context key
	SetCreatorContextKey(&#34;Creator&#34;) //set creator context key
</pre></div></li>

<li><p>Register mutiple models with the <code>RegisterModel</code> method.</p>

<div class="highlight highlight-go"><pre>activity.RegisterModels(&amp;Post{},&amp;Product{})
</pre></div></li>

<li><p>Register a model with the <code>RegisterModel</code>  method.</p>

<div class="highlight highlight-go"><pre>	activity.RegisterModel(&amp;model.Page{}).
	SetKeys(&#34;VersionName&#34;). // add keys
	SetLink(func(page interface{}) string {
		return fmt.Sprintf(&#34;/admin/pages/%d?version=%s&#34;, page.ID, page.VersionName)
	}). // set link
	AddIgnoredFields(&#34;ID&#34;, &#34;Updatedat&#34;). // ignore fields
	AddTypeHanders(...). // add type handlers
	SetAddExplicitly(ture) // will ingore this model when using the callback db

</pre></div></li>

<li><p>Record a activity log</p>

<div class="highlight highlight-go"><pre>	// record activity log from a context
	ctx := context.WithValue(context.Background(), 	DBContextKey, db)
	ctx  = ContextWithCreator(ctx, user)
	activity.AddRecords(ActivityEdit, ctx, newpage)

	// record activity log directly using known db and creator
	activity.AddEditRecord(user,newpage, db)
	activity.AddEditRecordWithOld(user,oldpage,newpage, db)

	// use db callback to automatically process the registered model
	activity.RegisterCallbackOnDB(db, &#34;creator&#34;)
</pre></div></li>
</ul>

<h2>Example</h2>

<bran-code language='go'>
<template slot='sourcecode'>ab := activity.Activity()
ab.RegisterModel(&amp;models.Post{})
ab.ConfigureAdmin(b, db)
ab.RegisterCallbackOnDB(db, &#34;Creator&#34;)</template>
</bran-code>
</div>
</div>

<div class='ml-4 sm:w-3/12 font-medium text-base hidden sm:block text-gray-600'>
<div class='sticky top-4'>On This Page<toc></toc></div>
</div>
</div>
</main>
</div>
</div>
</body>
</html>
